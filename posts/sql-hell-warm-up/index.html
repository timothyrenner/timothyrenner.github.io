<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SQL Hell, Warm Up | Timothy Renner</title><meta name=keywords content><meta name=description content="Do you consider yourself an explorer in the furthest regions of programming experience? Do you like pushing the boundaries of proper practice and good taste when it comes to solving programming problems? Have you ever wondered - I bet I could solve that with SQL?
Me too. And it turns out in many cases, you can. Often you shouldn&rsquo;t, but you can. In this post and the next couple I&rsquo;m going to be exploring the furthest reaches of what we can do with the database language every dev knows at least a little bit of."><meta name=author content="Timothy Renner"><link rel=canonical href=/posts/sql-hell-warm-up/><link crossorigin=anonymous href=/assets/css/stylesheet.bccfefac377bc340f06c260aed1bddf49a4354816d7c570d6aac75a997986c95.css integrity="sha256-vM/vrDd7w0DwbCYK7Rvd9JpDVIFtfFcNaqx1qZeYbJU=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=favicon.ico><link rel=icon type=image/png sizes=16x16 href=favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=favicon-32x32.png><link rel=apple-touch-icon href=apple-touch-icon.png><link rel=mask-icon href=safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="SQL Hell, Warm Up"><meta property="og:description" content="Do you consider yourself an explorer in the furthest regions of programming experience? Do you like pushing the boundaries of proper practice and good taste when it comes to solving programming problems? Have you ever wondered - I bet I could solve that with SQL?
Me too. And it turns out in many cases, you can. Often you shouldn&rsquo;t, but you can. In this post and the next couple I&rsquo;m going to be exploring the furthest reaches of what we can do with the database language every dev knows at least a little bit of."><meta property="og:type" content="article"><meta property="og:url" content="/posts/sql-hell-warm-up/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-07T00:00:00+00:00"><meta property="article:modified_time" content="2023-01-07T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="SQL Hell, Warm Up"><meta name=twitter:description content="Do you consider yourself an explorer in the furthest regions of programming experience? Do you like pushing the boundaries of proper practice and good taste when it comes to solving programming problems? Have you ever wondered - I bet I could solve that with SQL?
Me too. And it turns out in many cases, you can. Often you shouldn&rsquo;t, but you can. In this post and the next couple I&rsquo;m going to be exploring the furthest reaches of what we can do with the database language every dev knows at least a little bit of."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"/posts/"},{"@type":"ListItem","position":3,"name":"SQL Hell, Warm Up","item":"/posts/sql-hell-warm-up/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SQL Hell, Warm Up","name":"SQL Hell, Warm Up","description":"Do you consider yourself an explorer in the furthest regions of programming experience? Do you like pushing the boundaries of proper practice and good taste when it comes to solving programming problems? Have you ever wondered - I bet I could solve that with SQL?\nMe too. And it turns out in many cases, you can. Often you shouldn\u0026rsquo;t, but you can. In this post and the next couple I\u0026rsquo;m going to be exploring the furthest reaches of what we can do with the database language every dev knows at least a little bit of.","keywords":[],"articleBody":"Do you consider yourself an explorer in the furthest regions of programming experience? Do you like pushing the boundaries of proper practice and good taste when it comes to solving programming problems? Have you ever wondered - I bet I could solve that with SQL?\nMe too. And it turns out in many cases, you can. Often you shouldn’t, but you can. In this post and the next couple I’m going to be exploring the furthest reaches of what we can do with the database language every dev knows at least a little bit of. And I’m going to be doing this by solving Advent of Code problems.\nThe Problem My first post on this will be the day 1 problem, and will serve as a little teaser of the terrible, terrible things I’m going to show you. You can familiarize yourself with the problem here, https://adventofcode.com/2022/day/1, but the gist is this:\nWe get a file with sequences of numbers, one number per line. The number represents the number of calories of snacks in an elf’s bag. We want to know how many calories the elf carrying the most has in their bag. We could be given labels as a second column for each elf, but that would make things too easy, so instead we get line breaks between elves.\nHere, the first elf has 6000 calories, the second 4000, the third 11000. You get the idea.\nWe want to know how many calories the elf who’s carrying the most calories has. Can we do it with SQL? Yes. Should we? Doesn’t matter we’re doin it anyway.\nI’m building this with Quarto, which is a way of building computational documents. Conveniently it allows for SQL cells, so I won’t be tempted to cheat by using a language with variables and loops. First, a little boilerplate. This code configures the SQL fences in Quarto (powered by knitr, an R package) to use the same database connection for the document.\nlibrary(\"DBI\") db = dbConnect(duckdb::duckdb(), dbdir=\":memory:\") knitr::opts_chunk$set(connection=\"db\") The database I’m using is DuckDB, which is a pretty hot item in the data world right now. It’s the fastest, simplest way to do in-process SQL on tabular data.\nFor the uninitiated, DuckDB is an in-process OLAP database engine similar to SQLite. While SQLite is row oriented and weakly typed, DuckDB is columnar and strongly typed. It’s much more than “SQLite for OLAP” though. Thanks to the magic of Apache Arrow, DuckDB can function as a SQL engine for tabular data that can read from and write to nearly any data source for tabular data - CSVs, Parquet, even Pandas data frames. You can take a collection of CSV files and build a full end-to-end data pipeline with it, effectively making it an on-demand miniature data warehouse.\nWhat we’re about to do to it takes advantage of almost none of those things.\nSetup First piece of violence: this is obviously not a csv file. It has no header, no delimiter, and null rows delimit different elves for all of the values preceding it since the last null value.\nIt’s nothing like a csv but we’re gonna call it one so we can read it into DuckDB. And believe me things are only going downhill from here.\nCREATE OR REPLACE TABLE elf_calories (calories INTEGER); COPY elf_calories FROM 'input.csv'; SELECT COUNT(*) FROM elf_calories count_star() 2252 1 records\nWe need to do a little validation to ensure that we read the right values.\nwc -l input.csv 2252 input.csv Looks good, at least the rows match. Validate the schema too to make sure DuckDB isn’t doing weird stuff to the types.\nPRAGMA table_info('elf_calories') cid name type notnull dflt_value pk 0 calories INTEGER FALSE NA FALSE 1 records\nLooks good - integers are what we expect. Double check that the first few rows match the file’s head.\nSELECT * FROM elf_calories calories 7569 1357 10134 4696 4423 8869 3562 6597 NA 4038 Displaying records 1 - 10\nAnd now the file…\nhead -n 10 input.csv 7569 1357 10134 4696 4423 8869 3562 6597 4038 Alrighty looks like the I/O part is good. Now the next part is where moderately seasoned programmers can say “well let’s write a loop and we’ll do a running sum per elf, then pick the one with the max.” Programmers who want to flex a little will say “I’m going to use a reduce and partition_by operation and write it in one line.”\nWe, on the other hand, are working in a language that doesn’t even have variables, let alone loops. We have to figure out how to walk along these sequences of numbers and assign some kind of identifier to each list of numbers between the line breaks.\nIt is possible. Start by enumerating each row. We’ll use a window function without a window cause at this point nothing’s off the table in terms of terrible practices.\nWhy is this bad? We’re relying on the order of the input file to convey information. Now we are told the order matters but how many times have you gotten a dataset where the docs said one thing and you get something different? In this case, we have to trust the data but in real life - never trust the data.\nWhile I’m here creating the first view I can also make a note when the breaks are that signify a different elf with an indicator column. This will be important momentarily.\nCREATE OR REPLACE VIEW elf_calories_counted AS ( SELECT calories, ROW_NUMBER() OVER () AS row, calories IS NULL AS break, FROM elf_calories ); Note that DuckDB has no problem with that final trailing comma on the SELECT. It’s really easy to add, remove, and reorder columns because we don’t have to keep track of the last column any more. DuckDB is full of convenient additions to the SQL dialect like this that make life just that much better for analysts and data engineers. It’s 1000x better than leading commas, that’s for sure. Don’t @ me leading commas look terrible and you know it. Anyway, here’s our table.\nSELECT * FROM elf_calories_counted ORDER BY row ASC LIMIT 10; calories row break 7569 1 FALSE 1357 2 FALSE 10134 3 FALSE 4696 4 FALSE 4423 5 FALSE 8869 6 FALSE 3562 7 FALSE 6597 8 FALSE NA 9 TRUE 4038 10 FALSE Displaying records 1 - 10\nLooks good so far, the first eight rows are for the first elf, as indicated by the break column being true on row 9. Let’s check the bottom 10 as well.\nSELECT * FROM elf_calories_counted ORDER BY row DESC LIMIT 10; calories row break 3507 2252 FALSE 7588 2251 FALSE 1229 2250 FALSE 8594 2249 FALSE 7982 2248 FALSE 9613 2247 FALSE 6988 2246 FALSE 6810 2245 FALSE 3997 2244 FALSE NA 2243 TRUE Displaying records 1 - 10\nNow comes the fun part. Notice we can isolate the elves by pulling out all records with break equal to true. We’ll have a view with one row per elf and an ID for that elf. Sounds handy, let’s do that.\nCREATE OR REPLACE VIEW elf_calorie_breaks AS ( SELECT row AS elf_id FROM elf_calories_counted WHERE calories IS NULL ); SELECT * FROM elf_calorie_breaks LIMIT 10 elf_id 9 18 29 34 47 55 58 64 78 83 Displaying records 1 - 10\nSo now what do we have? We have one row ID per elf. An elf ID, basically. But not just any elf ID, it’s an ordered elf ID that can be compared to the row IDs in the original table. Each row ID in the original table is going to be less than the elf ID it needs to be assigned to.\nAbandon Hope We can attach the elf ID to the rows by performing an inequality join between our elf IDs. Now, pretty much every time you do a real join - like for your job and stuff - it’s an equality match between columns in the two tables. But joins just need a boolean predicate, and you can use any boolean operators (or just TRUE for a cross join). In real life, you usually don’t need inequality joins because we design tables to be joined via these newfangled things called primary and foreign keys. Perhaps you have heard of those.\nNo such luck here though.\nBUT it’s not as simple as just an inequality join because that would assign every single elf ID to the first eight rows, then all but the first for the next list of calories, and so forth. A massive explosion in cardinality.\nThe solution is straightforward though - we need just the minimum elf ID of the possible elf IDs, so throw in a group by and aggregate.\nCREATE OR REPLACE VIEW elf_calories_assigned AS ( SELECT cal.calories, cal.row, MIN(elf.elf_id) AS elf_id, FROM elf_calories_counted AS cal LEFT JOIN elf_calorie_breaks AS elf ON cal.row \u003c elf.elf_id -- Remove the breaks. Wouldn't affect the result when summing but makes -- diagnostics simpler. WHERE cal.calories IS NOT NULL GROUP BY cal.calories, cal.row ); Just take a moment and admire the awfulness of cal.row \u003c elf.elf_id. And think about the edge cases for a second. What happens to the last elf in the file? Well, since the file doesn’t end with a blank line, there are no elf IDs that satisfy the inequality join above, so we can lose the rows if we’re not careful. Hence a LEFT JOIN instead of an INNER JOIN. There is one single NULL elf ID representing that last elf.\nOkay enough of that, let’s answer the question. The hard part’s over, now it’s a trivial GROUP BY, aggregation, and ORDER BY.\nSELECT elf_id, SUM(calories) AS total_calories, FROM elf_calories_assigned GROUP BY elf_id ORDER BY total_calories DESC elf_id total_calories 1234 xxxxx 1234 xxxxx 1234 xxxxx 1234 xxxxx 1234 xxxxx 1234 xxxxx 1234 xxxxx 1234 xxxxx 1234 xxxxx 1234 xxxxx Displaying records 1 - 10\nAnd there’s our winner. What, you didn’t think I’d just drop the answer here would you?\nPart 2 Part 2 of the problem is to get the total calories for the top three elves. Now using SQL is an advantage, it’s als trivial to answer this with a query with the views we already have.\nWITH top3 AS ( SELECT elf_id, SUM(calories) AS total_calories, FROM elf_calories_assigned GROUP BY elf_id ORDER BY total_calories DESC LIMIT 3 ) SELECT SUM(total_calories) FROM top3; sum(total_calories) xxxxxx 1 records\nPiece of cake. Or cookie. Or donut. Probably all of those cause that’s a lot of calories and I don’t think it’s all trail mix.\nWhy? It was fun. Sort of.\nI’ve got a few more of these as well, this is just a warm up. Where we’re going, this will seem like a memory of heaven.\n","wordCount":"1789","inLanguage":"en","datePublished":"2023-01-07T00:00:00Z","dateModified":"2023-01-07T00:00:00Z","author":{"@type":"Person","name":"Timothy Renner"},"mainEntityOfPage":{"@type":"WebPage","@id":"/posts/sql-hell-warm-up/"},"publisher":{"@type":"Organization","name":"Timothy Renner","logo":{"@type":"ImageObject","url":"favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href accesskey=h title="Timothy Renner (Alt + H)">Timothy Renner</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=posts/ title=Blog><span>Blog</span></a></li><li><a href=about/ title=About><span>About</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>SQL Hell, Warm Up</h1><div class=post-meta><span title='2023-01-07 00:00:00 +0000 UTC'>January 7, 2023</span>&nbsp;·&nbsp;Timothy Renner</div></header><div class=post-content><p>Do you consider yourself an explorer in the furthest regions of programming experience?
Do you like pushing the boundaries of proper practice and good taste when it comes to solving programming problems?
Have you ever wondered - <em>I bet I could solve that with SQL</em>?</p><p>Me too.
And it turns out in many cases, you can.
Often you <em>shouldn&rsquo;t</em>, but you can.
In this post and the next couple I&rsquo;m going to be exploring the furthest reaches of what we can do with the database language every dev knows at least a little bit of.
And I&rsquo;m going to be doing this by solving <a href=https://adventofcode.com>Advent of Code</a> problems.</p><h2 id=the-problem>The Problem<a hidden class=anchor aria-hidden=true href=#the-problem>#</a></h2><p>My first post on this will be the day 1 problem, and will serve as a little teaser of the terrible, terrible things I&rsquo;m going to show you.
You can familiarize yourself with the problem here, <a href=https://adventofcode.com/2022/day/1>https://adventofcode.com/2022/day/1</a>, but the gist is this:</p><p>We get a file with sequences of numbers, one number per line.
The number represents the number of calories of snacks in an elf&rsquo;s bag.
We want to know how many calories the elf carrying the most has in their bag.
We <em>could</em> be given labels as a second column for each elf, but that would make things too easy, so instead we get line breaks between elves.</p><p><img loading=lazy src=figure_1.png alt></p><p>Here, the first elf has 6000 calories, the second 4000, the third 11000.
You get the idea.</p><p>We want to know how many calories the elf who&rsquo;s carrying the most calories has.
Can we do it with SQL?
Yes.
Should we?
Doesn&rsquo;t matter we&rsquo;re doin it anyway.</p><p>I&rsquo;m building this with <a href=https://quarto.org/>Quarto</a>, which is a way of building computational documents.
Conveniently it allows for SQL cells, so I won&rsquo;t be tempted to cheat by using a language with variables and loops.
First, a little boilerplate.
This code configures the SQL fences in Quarto (powered by <a href=https://yihui.org/knitr/>knitr</a>, an R package) to use the same database connection for the document.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-r data-lang=r><span style=display:flex><span><span style=color:#a6e22e>library</span>(<span style=color:#e6db74>&#34;DBI&#34;</span>)
</span></span><span style=display:flex><span>db <span style=color:#f92672>=</span> <span style=color:#a6e22e>dbConnect</span>(duckdb<span style=color:#f92672>::</span><span style=color:#a6e22e>duckdb</span>(), dbdir<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;:memory:&#34;</span>)
</span></span><span style=display:flex><span>knitr<span style=color:#f92672>::</span>opts_chunk<span style=color:#f92672>$</span><span style=color:#a6e22e>set</span>(connection<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;db&#34;</span>)
</span></span></code></pre></div><p>The database I&rsquo;m using is <a href=https://duckdb.org/>DuckDB</a>, which is a pretty hot item in the data world right now.
It&rsquo;s the fastest, simplest way to do in-process SQL on tabular data.</p><p>For the uninitiated, DuckDB is an in-process OLAP database engine similar to SQLite.
While SQLite is row oriented and weakly typed, DuckDB is columnar and strongly typed.
It&rsquo;s much more than &ldquo;SQLite for OLAP&rdquo; though.
Thanks to the magic of <a href=https://arrow.apache.org/>Apache Arrow</a>, DuckDB can function as a SQL engine for tabular data that can read from and write to nearly any data source for tabular data - CSVs, Parquet, even Pandas data frames.
You can take a collection of CSV files and build a full end-to-end data pipeline with it, effectively making it an on-demand miniature data warehouse.</p><p>What we&rsquo;re about to do to it takes advantage of almost none of those things.</p><h2 id=setup>Setup<a hidden class=anchor aria-hidden=true href=#setup>#</a></h2><p>First piece of violence: this is obviously not a csv file.
It has no header, no delimiter, and null rows delimit different elves for all of the values preceding it since the last null value.</p><p>It&rsquo;s nothing like a csv but we&rsquo;re gonna call it one so we can read it into DuckDB.
And believe me things are only going downhill from here.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>TABLE</span> elf_calories (calories INTEGER);
</span></span><span style=display:flex><span><span style=color:#66d9ef>COPY</span> elf_calories <span style=color:#66d9ef>FROM</span> <span style=color:#e6db74>&#39;input.csv&#39;</span>;
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>COUNT</span>(<span style=color:#f92672>*</span>) <span style=color:#66d9ef>FROM</span> elf_calories
</span></span></code></pre></div><table><thead><tr><th style=text-align:right>count_star()</th></tr></thead><tbody><tr><td style=text-align:right>2252</td></tr></tbody></table><p>1 records</p><p>We need to do a little validation to ensure that we read the right values.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wc -l input.csv
</span></span></code></pre></div><pre><code>    2252 input.csv
</code></pre><p>Looks good, at least the rows match.
Validate the schema too to make sure DuckDB isn&rsquo;t doing weird stuff to the types.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>PRAGMA table_info(<span style=color:#e6db74>&#39;elf_calories&#39;</span>)
</span></span></code></pre></div><table><thead><tr><th style=text-align:right>cid</th><th style=text-align:left>name</th><th style=text-align:left>type</th><th style=text-align:left>notnull</th><th style=text-align:left>dflt_value</th><th style=text-align:left>pk</th></tr></thead><tbody><tr><td style=text-align:right>0</td><td style=text-align:left>calories</td><td style=text-align:left>INTEGER</td><td style=text-align:left>FALSE</td><td style=text-align:left>NA</td><td style=text-align:left>FALSE</td></tr></tbody></table><p>1 records</p><p>Looks good - integers are what we expect.
Double check that the first few rows match the file&rsquo;s head.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> elf_calories
</span></span></code></pre></div><table><thead><tr><th style=text-align:right>calories</th></tr></thead><tbody><tr><td style=text-align:right>7569</td></tr><tr><td style=text-align:right>1357</td></tr><tr><td style=text-align:right>10134</td></tr><tr><td style=text-align:right>4696</td></tr><tr><td style=text-align:right>4423</td></tr><tr><td style=text-align:right>8869</td></tr><tr><td style=text-align:right>3562</td></tr><tr><td style=text-align:right>6597</td></tr><tr><td style=text-align:right>NA</td></tr><tr><td style=text-align:right>4038</td></tr></tbody></table><p>Displaying records 1 - 10</p><p>And now the file&mldr;</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>head -n <span style=color:#ae81ff>10</span> input.csv
</span></span></code></pre></div><pre><code>7569
1357
10134
4696
4423
8869
3562
6597

4038
</code></pre><p>Alrighty looks like the I/O part is good.
Now the next part is where moderately seasoned programmers can say &ldquo;well let&rsquo;s write a loop and we&rsquo;ll do a running sum per elf, then pick the one with the max.&rdquo;
Programmers who want to flex a little will say &ldquo;I&rsquo;m going to use a reduce and partition_by operation and write it in one line.&rdquo;</p><p>We, on the other hand, are working in a language that doesn&rsquo;t even have <em>variables</em>, let alone loops.
We have to figure out how to walk along these sequences of numbers and assign some kind of identifier to each list of numbers between the line breaks.</p><p>It is possible.
Start by enumerating each row.
We&rsquo;ll use a window function without a window cause at this point nothing&rsquo;s off the table in terms of terrible practices.</p><p><strong>Why is this bad?</strong>
We&rsquo;re relying on the order of the input file to convey information.
Now we are <em>told</em> the order matters but how many times have you gotten a dataset where the docs said one thing and you get something different?
In this case, we have to trust the data but in real life - never trust the data.</p><p>While I&rsquo;m here creating the first view I can also make a note when the breaks are that signify a different elf with an indicator column.
This will be important momentarily.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>VIEW</span> elf_calories_counted <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>        calories,
</span></span><span style=display:flex><span>        ROW_NUMBER() OVER () <span style=color:#66d9ef>AS</span> <span style=color:#66d9ef>row</span>,
</span></span><span style=display:flex><span>        calories <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span> <span style=color:#66d9ef>AS</span> break,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> elf_calories
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>Note that DuckDB has no problem with that final trailing comma on the <code>SELECT</code>.
It&rsquo;s really easy to add, remove, and reorder columns because we don&rsquo;t have to keep track of the last column any more.
DuckDB is full of convenient additions to the SQL dialect like this that make life just that much better for analysts and data engineers.
It&rsquo;s 1000x better than <em>leading</em> commas, that&rsquo;s for sure.
Don&rsquo;t @ me leading commas look terrible and you know it.
Anyway, here&rsquo;s our table.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> elf_calories_counted <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>ASC</span> <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>10</span>;
</span></span></code></pre></div><table><thead><tr><th style=text-align:right>calories</th><th style=text-align:right>row</th><th style=text-align:left>break</th></tr></thead><tbody><tr><td style=text-align:right>7569</td><td style=text-align:right>1</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>1357</td><td style=text-align:right>2</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>10134</td><td style=text-align:right>3</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>4696</td><td style=text-align:right>4</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>4423</td><td style=text-align:right>5</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>8869</td><td style=text-align:right>6</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>3562</td><td style=text-align:right>7</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>6597</td><td style=text-align:right>8</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>NA</td><td style=text-align:right>9</td><td style=text-align:left>TRUE</td></tr><tr><td style=text-align:right>4038</td><td style=text-align:right>10</td><td style=text-align:left>FALSE</td></tr></tbody></table><p>Displaying records 1 - 10</p><p>Looks good so far, the first eight rows are for the first elf, as indicated by the <code>break</code> column being true on row 9.
Let&rsquo;s check the bottom 10 as well.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> elf_calories_counted <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>DESC</span> <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>10</span>;
</span></span></code></pre></div><table><thead><tr><th style=text-align:right>calories</th><th style=text-align:right>row</th><th style=text-align:left>break</th></tr></thead><tbody><tr><td style=text-align:right>3507</td><td style=text-align:right>2252</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>7588</td><td style=text-align:right>2251</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>1229</td><td style=text-align:right>2250</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>8594</td><td style=text-align:right>2249</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>7982</td><td style=text-align:right>2248</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>9613</td><td style=text-align:right>2247</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>6988</td><td style=text-align:right>2246</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>6810</td><td style=text-align:right>2245</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>3997</td><td style=text-align:right>2244</td><td style=text-align:left>FALSE</td></tr><tr><td style=text-align:right>NA</td><td style=text-align:right>2243</td><td style=text-align:left>TRUE</td></tr></tbody></table><p>Displaying records 1 - 10</p><p>Now comes the fun part.
Notice we can isolate the elves by pulling out all records with <code>break</code> equal to true.
We&rsquo;ll have a view with one row per elf <em>and</em> an ID for that elf.
Sounds handy, let&rsquo;s do that.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>VIEW</span> elf_calorie_breaks <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>row</span> <span style=color:#66d9ef>AS</span> elf_id
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> elf_calories_counted
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>WHERE</span> calories <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>FROM</span> elf_calorie_breaks <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>10</span>
</span></span></code></pre></div><table><thead><tr><th style=text-align:right>elf_id</th></tr></thead><tbody><tr><td style=text-align:right>9</td></tr><tr><td style=text-align:right>18</td></tr><tr><td style=text-align:right>29</td></tr><tr><td style=text-align:right>34</td></tr><tr><td style=text-align:right>47</td></tr><tr><td style=text-align:right>55</td></tr><tr><td style=text-align:right>58</td></tr><tr><td style=text-align:right>64</td></tr><tr><td style=text-align:right>78</td></tr><tr><td style=text-align:right>83</td></tr></tbody></table><p>Displaying records 1 - 10</p><p>So now what do we have?
We have one row ID per elf.
An elf ID, basically.
But not just any elf ID, it&rsquo;s an <em>ordered</em> elf ID that can be compared to the row IDs in the original table.
<strong>Each row ID in the original table is going to be less than the elf ID it needs to be assigned to.</strong></p><h3 id=abandon-hope>Abandon Hope<a hidden class=anchor aria-hidden=true href=#abandon-hope>#</a></h3><p>We can attach the elf ID to the rows by performing an <strong>inequality join</strong> between our elf IDs.
Now, pretty much every time you do a real join - like for your job and stuff - it&rsquo;s an equality match between columns in the two tables.
But joins just need a boolean predicate, and you can use any boolean operators (or just <code>TRUE</code> for a cross join).
In real life, you usually don&rsquo;t need inequality joins because we design tables to be joined via these newfangled things called <em>primary and foreign keys</em>.
Perhaps you have heard of those.</p><p>No such luck here though.</p><p>BUT it&rsquo;s not as simple as <em>just</em> an inequality join because that would assign <em>every single elf ID</em> to the first eight rows, then all but the first for the next list of calories, and so forth.
A massive explosion in cardinality.</p><p><img loading=lazy src=figure_2a.png alt></p><p>The solution is straightforward though - we need just the <em>minimum</em> elf ID of the possible elf IDs, so throw in a group by and aggregate.</p><p><img loading=lazy src=figure_2b.png alt></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>OR</span> <span style=color:#66d9ef>REPLACE</span> <span style=color:#66d9ef>VIEW</span> elf_calories_assigned <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>        cal.calories,
</span></span><span style=display:flex><span>        cal.<span style=color:#66d9ef>row</span>,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>MIN</span>(elf.elf_id) <span style=color:#66d9ef>AS</span> elf_id,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span>
</span></span><span style=display:flex><span>        elf_calories_counted <span style=color:#66d9ef>AS</span> cal
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>LEFT</span> <span style=color:#66d9ef>JOIN</span> elf_calorie_breaks <span style=color:#66d9ef>AS</span> elf <span style=color:#66d9ef>ON</span>
</span></span><span style=display:flex><span>        cal.<span style=color:#66d9ef>row</span> <span style=color:#f92672>&lt;</span> elf.elf_id
</span></span><span style=display:flex><span>    <span style=color:#75715e>-- Remove the breaks. Wouldn&#39;t affect the result when summing but makes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>-- diagnostics simpler.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>WHERE</span> cal.calories <span style=color:#66d9ef>IS</span> <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> cal.calories, cal.<span style=color:#66d9ef>row</span>
</span></span><span style=display:flex><span>);
</span></span></code></pre></div><p>Just take a moment and admire the awfulness of <code>cal.row &lt; elf.elf_id</code>.
And think about the edge cases for a second.
What happens to the last elf in the file?
Well, since the file doesn&rsquo;t end with a blank line, there are no elf IDs that satisfy the inequality join above, so we can lose the rows if we&rsquo;re not careful.
Hence a <code>LEFT JOIN</code> instead of an <code>INNER JOIN</code>.
There is one single NULL elf ID representing that last elf.</p><p>Okay enough of that, let&rsquo;s answer the question.
The hard part&rsquo;s over, now it&rsquo;s a trivial <code>GROUP BY</code>, aggregation, and <code>ORDER BY</code>.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> 
</span></span><span style=display:flex><span>    elf_id,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SUM</span>(calories) <span style=color:#66d9ef>AS</span> total_calories,
</span></span><span style=display:flex><span><span style=color:#66d9ef>FROM</span> elf_calories_assigned
</span></span><span style=display:flex><span><span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> elf_id
</span></span><span style=display:flex><span><span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> total_calories <span style=color:#66d9ef>DESC</span>
</span></span></code></pre></div><table><thead><tr><th style=text-align:right>elf_id</th><th style=text-align:right>total_calories</th></tr></thead><tbody><tr><td style=text-align:right>1234</td><td style=text-align:right>xxxxx</td></tr><tr><td style=text-align:right>1234</td><td style=text-align:right>xxxxx</td></tr><tr><td style=text-align:right>1234</td><td style=text-align:right>xxxxx</td></tr><tr><td style=text-align:right>1234</td><td style=text-align:right>xxxxx</td></tr><tr><td style=text-align:right>1234</td><td style=text-align:right>xxxxx</td></tr><tr><td style=text-align:right>1234</td><td style=text-align:right>xxxxx</td></tr><tr><td style=text-align:right>1234</td><td style=text-align:right>xxxxx</td></tr><tr><td style=text-align:right>1234</td><td style=text-align:right>xxxxx</td></tr><tr><td style=text-align:right>1234</td><td style=text-align:right>xxxxx</td></tr><tr><td style=text-align:right>1234</td><td style=text-align:right>xxxxx</td></tr></tbody></table><p>Displaying records 1 - 10</p><p>And there&rsquo;s our winner.
What, you didn&rsquo;t think I&rsquo;d just drop the answer here would you?</p><h2 id=part-2>Part 2<a hidden class=anchor aria-hidden=true href=#part-2>#</a></h2><p>Part 2 of the problem is to get the total calories for the top <strong>three</strong> elves.
Now using SQL is an advantage, it&rsquo;s als trivial to answer this with a query with the views we already have.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>WITH</span> top3 <span style=color:#66d9ef>AS</span> (
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>SELECT</span>
</span></span><span style=display:flex><span>        elf_id,
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>SUM</span>(calories) <span style=color:#66d9ef>AS</span> total_calories,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>FROM</span> elf_calories_assigned
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>GROUP</span> <span style=color:#66d9ef>BY</span> elf_id
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ORDER</span> <span style=color:#66d9ef>BY</span> total_calories <span style=color:#66d9ef>DESC</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>LIMIT</span> <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>SUM</span>(total_calories) <span style=color:#66d9ef>FROM</span> top3;
</span></span></code></pre></div><table><thead><tr><th style=text-align:right>sum(total_calories)</th></tr></thead><tbody><tr><td style=text-align:right>xxxxxx</td></tr></tbody></table><p>1 records</p><p>Piece of cake.
Or cookie.
Or donut.
Probably all of those cause that&rsquo;s a lot of calories and I don&rsquo;t think it&rsquo;s all trail mix.</p><h2 id=why>Why?<a hidden class=anchor aria-hidden=true href=#why>#</a></h2><p>It was fun.
Sort of.</p><p>I&rsquo;ve got a few more of these as well, this is just a warm up.
Where we&rsquo;re going, this will seem like a memory of heaven.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href>Timothy Renner</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>